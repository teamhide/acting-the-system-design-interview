# 02장. 일반적인 시스템 설계 면접 흐름

1. QPS(초당 쿼리 수)와 P99 지연 시간 같은 기능적 요구사항과 비기능적 요구사항을 명확히 구분한다. 단순한 시스템에서 시작해 확장해나가는 기능 설계를 원하는지, 즉시 확장 가능한 시스템 설계를 원하는지 물어본다.
2. 모든 것은 트레이드오프다. 
3. 면접을 주도하며 계속해서 논의 주제를 제안한다.
4. 시간을 신경쓴다.
5. 로깅, 모니터링, 경보, 감사를 논의한다.
6. 디버깅 가능성, 복잡성, 프라이버시를 포함한 테스트와 유지보수성을 논의한다.
7. 전체 시스템의 모든 구성 요소는 성능 저하와 실패를 고려하고 논의한다.
8. 시스템 다이어그램, 순서도, 시퀀스 다이어그램을 그린다.
9. 시스템은 항상 개선될 수 있다.

다음 목록은 대략적인 안내다. 면접마다 다르기에 무조건 이 순서대로 진행되는 것은 아니다.

1. 요구사항을 명확히 하며 트레이드오프 논의
2. API 명세 초안 작성
3. 데이터 모델 설계 및 분석
4. 실패 설계, 성능 저하, 모니터링, 경보 논의. 병목 현상, 부하 분산, SPOF 제거, 고가용성, 재해복구, 캐싱 등 기타 주제도 포함된다.
5. 복잡성과 트레이드오프, 유지보수와 폐기 프로세스, 비용을 논의한다.

## 2.1 요구사항 명확화와 트레이드오프 논의

면접에서 가장 중요한 것은 질문의 요구사항을 명확히 파악하는 것이다. 기능적 요구사항은 면접 시간의 20% 이상을 차지하기 때문에 10분 이내에 논의해야 한다. 빠르게 브레인스토밍하고 기능적 요굿항 목록을 작성한 다음 논의해야 한다. 면접관에서 모든 중요한 요구사항을 포착했는지 확인하고 싶지만 시간도 신경쓰고 있다고 말할 수도 있다.

30초에서 1분 정도 시스템의 전반적인 목적과 큰 그림의 비즈니스 요구사항에 부합하는지 논의하는 것으로 시작할 수 있다. 거의 모든 시스템에 공통적인 엔드포인트 상태 확인, 회원가입, 로그인 등을 간단히 언급할 수 있으며 간단한 논의를 넘어선다면 이는 면접 범위를 벗어난 것일 확률이 높다. 그 다음 일부 공통적인 기능적 요구사항에 관한 세부 사항을 논의한다.

- 사용자 범주/역할을 고려한다.
  - 누가 이 시스템을 어떻게 사용할 것인지 유저 스토리를 논의하고 작성한다. 
  - 기술적/비기술적에 대한 논의
    - 키/값 스토리지 같은 데이터베이스 서비스, 일관된 해싱등이 기술적 주제
    - 잘 알려진 소비자 앱을 설계하라와 같은 형식이 비기술적 주제
  - 사용자 역할을 나열한다. (구매자, 판매자, 게시자, 조회자, 개발자, 관리자)
  - 수치에 주의를 기울인다. 모든 기능적/비기능적 요구사항은 수치를 가지고 있어야 한다. 뉴스 항목을 가져온다면 항목이 몇개인가? 얼마나 오래 걸리며 몇 밀리초/초/시간/일인가?
  - 사용자 간 또는 사용자와 운영팀 간의 커뮤니케이션이 있는가?
  - 국제와(i18n)와 현지화(L10n) 지원, 국가나 지역 언어, 우편 주소, 가격, 다중 통화 지원이 필요한지 물어본다.
- 이를 바탕으로 확장성 요구사항을 명확히 한다. 일일 활성 사용자 수를 추정하고 일(day)이나 시간당 요청 빈도를 추정한다. 예를 들어 검색 서비스에 10억 명의 일일 사용자가 있고 각각 10개의 검색 요청을 제출한다면 일일 100억 건이나 시간당 4억 2천만 건의 요청이 있다고 볼 수 있다.
- 어떤 사용자가 어떤 데이터에 접근할 수 있는지 인증/인가 메커니즘을 논의한다. API 엔드포인트의 응답 본문 내용을 논의한다. 데이터를 얼마나 자주 검색하는지(실시간 또는 월간 보고서, 다른 주기)를 논의한다.
- 검색과 관련하여 가능한 사용 사례는 무엇인가?
- 분석은 일반적인 요구사항이다. A/B 테스트나 멀티암드 밴딧과 같은 실험에 관한 지원을 포함해 가능한 머신러닝 요구사항을 논의한다.
- 특정 사용자의 게시물을 가져오는 의사코드 함수 시그니처(예: fetchPosts(userId))를 작성하고 사용자 스토리와 일치시킨다. 어떤 요구사항이 필요하고 어떤 것이 범위를 벗어나는지 면접관과 논의한다.

항상 "다른 사용자 요구사항이 있나요?"라고 물어보고 이러한 가능성을 브레인스토밍한다. 면접관에게 모든 요구사항을 알려주기를 원한다는 인상을 주지 않는다.

시스템이 향후 다른 기능적 요구사항을 충족하게끔 확장될 수 있다고 인식하고 있음을 보여주고 그러한 가능성을 브레인스토밍한다.

## 2.2 API 명세 초안 작성

일반적으로 5분 미만으로 GET/POST/PUT/DELETE 엔드포인트 초안을 작성하며 경로와 쿼리 매개변수를 포함한다. 면접관에게 여기에 많은 시간을 할애하지 않겠다고 알린다.

엔드포인트를 작성하기 전에 미리 기능적 요구사항을 명확히 한다. 그리고 API 명세를 제안하고 기능적 요구사항을 어떻게 충족하는지 설명한 다음 놓쳤을 수 있는 기능적 요구사항을 식별한다.

### 2.2.1 공통 API 엔드포인트

**상태 확인**

**회원가입과 로그인(인증)**

**사용자와 콘텐츠 관리**

## 2.3 사용자와 데이터 간의 연결과 처리

1단계
- 각 사용자 유형을 나타내는 부분을 그리고 기능 요구사항을 제공하는 각 시스템을 나타내는 부분을 그린다.
- 사용자와 시스템 간의 연결을 그린다.

2단계
- 요청 처리와 저장소 분리
- 비기능적 요구사항(실시간성과 최종적 일관성)을 기반으로 한 다양한 설계를 만든다.
- 공유 서비스를 고려한다.

3단계
- 시스템을 구성 요소로 나눈다. 일반적으로 라이브러리나 서비스로 구분한다.
- 연결을 그린다.
- 로깅, 모니터링, 경보, 보안을 고려한다.

4단계
- 시스템 설계에 관한 요약을 포함한다.
- 새로운 추가 요구사항을 제공한다.
- 내결함성을 분석한다. 각 구성 요소에서 무엇이 잘못될 수 있는가? 네트워크 지연, 불일치, 선형화 불가능, 각 상황을 방지하거나 해소하고 구성 요소와 전체 시스템의 내결함성을 개선하기 위해 무엇을 할 수 있는가?

## 2.4 데이터 모델 설계

### 2.4.1 데이터베이스를 공유하는 여러 서비스의 단점의 예

### 2.4.2 동시 사용자 업데이트 충돌을 방지하는 기법

## 2.5 로깅, 모니터링, 경보

### 2.5.1 모니터링의 중요성

웹 서비스는 언제든 실패할 수 있고 이러한 실패는 얼마나 긴급하며 빠른 대응이 필요한지에 따라 분류할 수 있다.

### 2.5.2 관찰 가능성

로깅, 메트릭, 추적없이는 시스템이 불투명하다.
- 지연 시간
- 트래픽
- 오류
- 포화

### 2.5.3 경보 대응

온콜 엔지니어가 모든 경보의 원인을 파악할 수 없으므로 경보 목록, 발생 가능한 원인, 원인을 찾고 해결하는 절차가 포함된 런북을 준비해야 한다.

### 2.5.4 애플리케이션 수준 로깅 툴

### 2.5.5 데이터 품질에 대한 스트리밍과 배치 감사

### 2.5.6 데이터 이상 탐지

### 2.5.7 무감지 오류와 감사

### 2.5.8 관찰 가능성 추가 자료

## 2.6 검색창

### 2.6.1 소개

검색을 구현하는 일반적인 기법은 다음과 같다.

1. SQL LIKE 
2. match-sorter와 같은 라이브러리
3. ElasticSearch와 같은 검색 엔진. 확장 가능하며 PB단위의 데이터 처리 가

### 2.6.2 일래스틱서치를 활용한 검색창 구현

### 2.6.3 일래스틱서치 인덱스와 수집

일래스틱서치 인덱스 생성은 사용자가 검색창에서 검색 쿼리를 제출할 때 검색해야 할 문서를 수집한 다음 인덱싱 작업을 수행하는 것으로 구성된다.

주기적 혹은 이벤트 트리거 방식의 인덱싱이나 벌크 API를 사용한 삭제 요청으로 인덱스를 최신 상태로 유지할 수 있다.

### 2.6.4 SQL 대신 일래스틱서치 사용하기

일래스틱서치는 스키마가 없는 데이터베이스이며 정규화나 기본 키와 이래 키 같은 테이블 간의 관계 개념이 없다. SQL과 달리 일래스틱서치는 명령 쿼리 책임 분리(CQRS)나 ACID를 제공하지 않는다.

### 2.6.5 서비스에서 검색 구현하기

### 2.6.6 검색에 관한 추가 자료

## 2.7 기타 논의 가능한 주제

### 2.7.1 애플리케이션 유지보수와 확장

- 유지보수는 면접 중에 논의될 수 있다. 호환성을 깨는 변경을 도입하는 업그레이드를 어떻게 처리할 것인가?
- 향후 개발해야 할 수 있는 기능과 시스템 설계
- 향후 필요하지 않을 수 있는 기능은 무엇이고 이를 어떻게 점진적으로 폐기하고 해체할 것인가?

### 2.7.2 다른 유형의 사용자 지원

### 2.7.3 대안적 아키텍처 결정

### 2.7.4 사용성과 피드백

### 2.7.5 에지 케이스와 새로운 제약 조건

면접 막바지에 면접관은 새로운 제약 조건을 제시할 수 있다. 

- 새로운 기능적 요구사항: 신용카드 결제를 지원하는 판매 서비스를 설계한 경우 결제 시스템이 각 국가의 다른 신용카드 결제 요구사항을 지원하게 하려면? 상점 크레딧과 같은 다른 결제 유형도 지원해야 한다면? 쿠폰?
- 텍스트 검색 서비스를 설계했다. 오디오/비디오로 확장할 수 있는가?
- 호텔 객실 예약 서비스를 설계했다. 사용자가 객실을 변경해야 한다면?
- 뉴스 피드 추천 서비스에 소셜 네트워킹 기능을 추가하기로 한다면?

**확장성과 성능**

- 사용자가 백만 명의 팔로워나 백만 명의 메시지 수신자를 가지고 있다면 어떻게 할 것인가? 긴 P99 메시지 전송 시간을 받아들일 수 있는가? 아니면 더 나은 성능을 내기 위해 설계해야 하는가?
- 지난 10년간 판매 데이터의 정확한 감사(Audit)를 수행해야 한다면 어떻게 할 것인가?

**지연 시간과 처리량**
- P99가 500ms 이내여야 한다면?
- 실시간 스트리밍을 지원하지 않는 비디오 스트리밍 서비스를 설계했다면, 실시간 스트리밍을 지원하려면? 100억개의 기기에서 동시에 백만개의 고해상도 비디오를 스트리밍할 수 있게 하려면?

**가용성과 내결함성**
- 모든 데이터가 DB에도 있으므로 고가용성이 필요하지 않은 캐시를 설계했다. 이 때 적어도 특정 데이터에 고가용성을 제공하려면?
- 판매 서비스가 트래픽이 늘어난다면 가용성을 늘리는 방법은?
- 시스템의 각 구성요소가 어떻게 실패할 수 있을까? 실패를 어떻게 방지 혹은 해소할 수 있을까?

**비용**

### 2.7.6 클라우드 네이티브 개념

마이크로서비스, 공유 서비스를 위한 서비스 메시와 사이드카(Istio), 컨테이너화(도커), 오케스트레이션(쿠버네티스), 자동화(Skaffold, Jenkins), IAC(테라폼, 헬름) 같은 클라우드 네이티브 개념으로 비기능적 요구사항을 해결하는 방법을 논의할 수 있다.

## 2.8 면접 후 회고와 평가

### 2.8.1 면접 직후 회고록 작성하기

### 2.8.2 평가 작성하기

### 2.8.3 언급하기 않은 세부 사항

50분 내에 시스템을 포괄적으로 논의하는 것은 불가능하다. 그 시간 내에 어느 세부 사항을 언급할 것인지 선택한다. 현재 지식을 기반으로 어떤 다른 세부 사항을 추가할 수 있다고 생각하는가? 왜 면접 중에 그것을 언급하기 않았는가?

### 2.8.4 면접 피드백

## 2.9 회사 면접하기
