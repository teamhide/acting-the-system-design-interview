# 01장. 시스템 설계 개념 둘러보기

## 1.1 트레이드오프 논의
시스템 설계는 완벽함을 추구하기보다는 주어진 리소스와 시간 안에서 현재와 미래의 요구사항을 가장 잘 만족시키는 시스템을 설계하기 위해 트레이드오프와 타협해야한다. 

시스템 설계 면접은 정답을 찾는 것이 아니다. 요구사항을 충족하기 위한 여러 가능한 접근 방식을 논의하고 그 트레이드오프를 평가하는 능력을 본다.

## 1.2 이 책을 어떻게 읽어야 할까?
시스템 설계 면접은 다른 면접과 마찬가지로 의사소통 능력, 순발력, 좋은 질문을 하는 능력, 그리고 성과에 대한 불안감 등을 평가한다. 

## 1.3 이 책의 개요

## 1.4 시스템의 다양한 서비스 확장 방식
### 1.4.1 시작: 앱의 소규모 초기 배포
우리는 사용자가 근처 베이글 카페에 대한 게시물을 읽고 작성할 수 있는 소비자 대상 앱인 'Beigel'이라는 앱을 만들었다. 그리고 앱의 초기 구성은 다음과 같다.
- 소비자 앱. 기본적으로 동일한 앱으로 세 가지 공통 플랫폼에 하나씩 제공된다.
  - 브라우저 앱
  - IOS 앱
  - 안드로이드 앱
- 소비자 앱을 제공하는 상태 비저장 백엔드 서비스. Go 또는 자바 서비스일 수 있다.
- 단일 클라우드 호스트에 포함된 SQL 데이터베이스

서비스를 처음 출시할 때는 사용자 수가 적고 요청 빈도가 낮을 수 있기에 단일 호스트로도 모든 요청을 수용할 수 있다. DNS를 설정해 모든 요청을 이 호스트로 보내게 한다.

처음에는 두 서비스를 같은 데이터 센터 내에서 각각 단일 클라우드 호스트에 배치할 수 있다. 브라우저 앱의 모든 요청을 Node.js 호스트로, Node.js 호스트와 두 모바일 앱의 요청을 백엔드 호스트로 보내게 DNS를 구성한다.

### 1.4.2 GeoDNS를 통한 확장
트래픽이 늘어남에 따라 여러 개의 동일한 백엔드 호스트를 세계 각지의 다른 데이터 센터에 배치할 수 있다. 클라이언트가 beigel.com 도메인을 통해 백엔드로 요청을 보내면 GeoDNS를 사용해 가장 가까운 데이터 센터로 라우팅한다.

### 1.4.3 캐싱 서비스 추가

### 1.4.4 콘텐츠 배포 네트워크(CDN)
CDN은 전 세계 여러 데이터 센터에 정적 파일의 복사본을 저장하므로 사용자는 가장 낮은 지연 시간으로 이 파일을 제공할 수 있는 데이터 센터에서 다운로드할 수 있다. CDN을 사용하면 지연 시간, 처리량, 신뢰성, 비용이 개선된다. 대표적으로 CloudFlare, Rackspace, AWS CloudFront등이 있다.

### 1.4.5 수평적 확장성과 클러스터 관리, 지속적 통합, 지속적 배포에 관한 간단한 논의
**CI/CD와 코드로서의 인프라(IaC)**
새로운 기능의 빠른 출시를 위해 젠킨스와 단위 테스트와 통합 테스트 도구를 사용한 지속적 통합(CI), 지속적 배포(CD)를 채택한다. 도커를 사용해 서비스를 컨테이너화하고 쿠버네티스나 도커 스웜을 사용해 확장과 부하 분산을 포함한 호스트 클러스터를 관리하며 앤서블, 테라폼을 사용해 다양한 클러스터에서 실행되는 여러 서비스의 구성을 관리한다.

**점진적 롤아웃과 롤백**

**실험**

### 1.4.6 기능적 분할과 교차 관심사의 중앙 집중화
**공유 서비스**
- 검색: ElasticSearch
- 로깅: ELK(ElasticSearch, Logstash, Kibana, Beats), Zipkin, Jaeger
- 모니터링
- API 게이트웨이

**API 게이트웨이**
API 게이트웨이는 클라이언트 요청을 적절한 백엔드 서비스로 라우팅하는 리버스 프록시다. 여러 서비스에 공통 기능을 제공하므로 개별 서비스에서 중복되지 않는다.
- 인가와 인증, 다른 접근 제어와 보안 정책
- 요청 수준의 로깅, 모니터링, 경보
- 속도 제한
- 요금 청구
- 분석

API 게이트웨이는 지연 시간을 추가하고 대규모 호스트 클러스터를 필요로 한다. 특정 요청을 처리하는 API 게이트웨이 호스트와 서비스의 호스트가 다른 데이터 센터에 있을수도 있고 이러한 경우 시스템 설계는 어색하고 복잡해진다.

해결책은 사이드카 패턴이라고도 불리는 서비스 메시를 사용하는 것이다. 일반적으로 Istio 같은 서비스 메시 프레임워크를 사용할 수 있다. 각 서비스의 모든 호스트는 주 서비스와 함께 사이드카를 실행할 수 있고 쿠버네티스 파드를 사용한다. 각 파드는 서비스(한 컨테이너)와 사이드카(다른 컨테이너)를 모두 포함할 수 있다.

이 아키텍처에서는 모든 서비스 요청과 응답이 사이드카를 통해 라우팅되며 서비스와 사이드카는 같은 호스트(같은 기기)에 있으므로 로컬 호스트를 통해 서로 주소를 지정할 수 있고 네트워크 지연이 없다. 다만 시스템 리소스를 소비한다.

**사이드카 없는 서비스 메시 - 최신 기술**
사이드카 프록시 로직을 클라이언트 호스트에 배치해 복잡성을 줄일 수 있다. 사이드카 없는 서비스 메시의 한계는 서비스와 같은 언어를 사용하는 클라이언트가 있어야 한다는 점이다. 아직 초기 개발 단계이며 GCP의 트래픽 디렉터를 예로 들 수 있다.

**명령 쿼리 책임 분리(CQRS)**
쓰기/읽기 작업을 기능적으로 분리해 별도의 서비스로 나누는 패턴이다. 데이터를 한 테이블에 쓰고 변환해 다른 테이블에 삽입하는 모든 설계가 CQRS의 예다. 

### 1.4.7 배치 및 스트리밍 추출, 변환, 적재(ETL)
일부 시스템의 데이터 처리 요청을 동기(즉시 응답 반환)일 필요가 없다. 로깅과 같은 시스템은 대량의 요청을 받기 때문에 ETL과 같은 비동기 접근 방식을 사용해야 한다.

이러한 배치 작업에는 카프카(또는 AWS 키네시스) 같은 이벤트 스트리밍 시스템과 Airflow 같은 ETL 배치 도구를 조합하여 사용할 수 있다.

주기적으로 배치 작업을 실행하는 대신 데이터를 지속적으로 처리하려면 Flink 같은 스트리밍 도구를 사용해도 된다. 예를 들어 사용자가 앱에 데이터를 입력하고 이를 사용해 몇 초나 몇 분내에 특정 추천이나 알림을 보내려면 최근 사용자 입력을 처리하는 Flink 파이프라인을 만들 수 있다. 물론 요청 빈도가 낮다면 배치 파이프라인으로 충분하다.

### 1.4.8 기타 필요 서비스
- 외부 사용자 인증/권한 부여를 위한 자격 증명 관리
- 다양한 공유 스토리지 서비스
- 비동기 처리
- 사용자 경험 개인화
- 검색
- 프라이버시 보호
- 사기 탐지

### 1.4.9 클라우드 vs 베어 메탈

### 1.4.10 서버리스: 서비스로서의 함수(FaaS)
기능을 자주 사용하지 않거나 엄격한 지연 시간 제한이 없다면 AWS 람다나 Azure 펑션 같은 Faas도 좋은 선택지이다. 다만 15분 시간 제한이나 콜드 스타트 문제를 내포한다.

### 1.4.11 결론: 백엔드 서비스 확장
